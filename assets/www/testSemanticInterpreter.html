<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />

	<title>Semantic Parser Test</title>

	<!--
		Copyright (C) 2012-2013 DFKI GmbH
		Deutsches Forschungszentrum fuer Kuenstliche Intelligenz
		German Research Center for Artificial Intelligence
		http://www.dfki.de

		Permission is hereby granted, free of charge, to any person obtaining a 
		copy of this software and associated documentation files (the 
		"Software"), to deal in the Software without restriction, including 
		without limitation the rights to use, copy, modify, merge, publish, 
		distribute, sublicense, and/or sell copies of the Software, and to 
		permit persons to whom the Software is furnished to do so, subject to 
		the following conditions:

		The above copyright notice and this permission notice shall be included 
		in all copies or substantial portions of the Software.

		THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS 
		OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF 
		MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. 
		IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY 
		CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, 
		TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
		SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
	-->
	
    <link rel="stylesheet" href="mmirf/res/styles/jquery.mobile-1.3.1.min.css" />
    
	<script type="text/javascript"src="mmirf/res/libs/jquery-1.9.1.min.js">
	</script>
	<!-- script type="text/javascript">
		//disable jQuery Mobiles navigation/history handling (-> allow simple # links within page)
		//NOTE this needs to be done, before jQuery Mobile JS is loaded!
		$(document).on("mobileinit", function(){
			$.mobile.hashListeningEnabled = false;
			$.mobile.pushStateEnabled = false;
			$.mobile.linkBindingEnabled = false;
		});
	</script-->
	<script type="text/javascript"src="mmirf/res/libs/jquery.mobile-1.3.1.js">
	</script>


	<script type="text/javascript"src="mmirf/res/libs/jpath.js">
	</script>
	<script type="text/javascript"src="mmirf/tools/initJSCC.js">
	</script>
	<script type="text/javascript"src="mmirf/res/libs/jscc.js"> 
	</script>

	<script type="text/javascript"src="mmirf/semantic/grammarConverter.js">
	</script>
	
	<script type="text/javascript"src="mmirf/tools/extensions/StringExtensions.js">
	</script>
	<script type="text/javascript"src="mmirf/tools/constants.js">
	</script>
	<script type="text/javascript"src="mmirf/plugins/directoryListing.js">
	</script>
	<script type="text/javascript"src="mmirf/tools/CommonUtils.js">
	</script>
	<script type="text/javascript"src="mmirf/manager/settings/languageManager.js">
	</script>
	
	<script type="text/javascript"src="mmirf/semantic/grammarParserTemplate.js">
	</script>
	<script type="text/javascript"src="mmirf/semantic/semanticInterpreter.js">
	</script>
	
	
	<script type="text/javascript"src="mmirf/res/libs/jsonlint.parser.js">
	</script>
	
	<!--script type="text/javascript" src="gen/grammar/de_grammar.js">
	</script-->
		
	<style type="text/css">
		
		.grid {
			display: inline-table;
		}
		.grid-cell {
			display: table-cell;
			vertical-align: bottom;
		}
		
		#language-selection-area .ui-select {
			display: inline;
		}
		
		#outputBox {
			font-family:monospace;
			font-size:12px;
			white-space: pre;
			overflow:scroll;
			border: thin solid lightGrey;
			height: 300px;
			width:100%;
		}
		
		code {
			white-space: pre;
		}
		
		#compileOutBox, #compiledParserOutBox {
			font-family:monospace;
			font-size:12px;
			white-space: pre;
			overflow:scroll;
			border: thin solid lightGrey;
			height: 300px;
			width:100%;
		}
		
		#compiledParserOutBox {
			height: 600px;
		}
		
		#interpretationBox, #interpretationBoxAlt {
			font-family:monospace;
			font-size:12px;
			white-space: pre;
			overflow:scroll;
			border: thin solid lightGrey;
			height: 300px;
			width:100%;
		}
		
		#stopwordBox, #stopwordBox2 {
			font-family:monospace;
			font-size:12px;
			white-space: pre;
			overflow:scroll;
			border: thin solid lightGrey;
			height: 3em;
			width:100%;
		}
	</style>
	
<!-- Test Code -->
<script type="text/javascript">
	
	var IS_DEBUG_ENABLED = true;
	
	var IS_FILE_READING_API = false;
	
	var DEFAULT_EXAMPLE_PHRASE = 'Radio spielen';
	
	if(!console){
		console = new Object();
	}
	if(!console.log){
		console.log = function(msg){ alert(msg);};
	}
	if(!console.debug){
		console.debug = console.log;
	}
	if(!console.info){
		console.info = console.log;
	}
	if(!console.warn){
		console.warn = console.log;
	}
	if(!console.error){
		console.error = console.log;
	}
	
	var mobileDS = window.mobileDS ||
	{};


	var forBrowser = true;
	
	var semanticInterpreter = mobileDS.SemanticInterpreter.getInstance();
	semanticInterpreter.get_json_grammar_url = function(id) { return 'config/languages/'+id+'/grammar.json'; };
	
	//TODO: (1) load directory_strucutre file and detect available JSON grammars, (2) create drop-down menu for languages
	//semanticInterpreter.setCurrentGrammar('de');

	var inputElement;
	var interpretElement;
	var stopwordElement;
	
	var compiledParser;
	var compileCount = 0;
	
	var theJSONGrammarURL = 'un-initialized';//semanticInterpreter.get_json_grammar_url('de');
	var theJSONgrammar = 'un-initialized';
	
	var optionGrammarFromFile = 'file-option';
	
	var initPage = function initPageImpl(){
		var languageManager = mobileDS.LanguageManager.getInstance();
				
		//get a default/"starting" language
		var defLang = languageManager.getLanguage();
		if( ! languageManager.existsGrammar(defLang)){
			defLang = null;
		}

		//create list with languages for which a grammar is available
		var allLangs = languageManager.getLanguages();
		var langs = [];
		for(var i=0, size = allLangs.length; i < size ; ++i){
			
			if(languageManager.existsGrammar(allLangs[i])){
				langs.push( allLangs[i] );
				
				if(defLang === null){
					defLang = allLangs[i];
				}
			}
			
		}
		
		if(defLang === null){
			defLang = '';
		}
		
		var langMenu = createLanguageMenu(langs, defLang);
		var isLang = function(id){
			for(var i=0,size=langs.length; i < size; ++i){
				if(langs[i] === id){
					return true;
				}
				return false;
			}
		};
		
		$('#grammar-id').val(defLang);
		theJSONGrammarURL = semanticInterpreter.get_json_grammar_url(defLang);
		
		$('#lang-selector-manual-input').hide();
		$('#lang-selector').replaceWith($.parseHTML(langMenu));
		$('#lang-selector').selectmenu({ inline: true });

		$("#lang-selector").on( "change", function(event, ui) {
			
			var prevLang = $('#grammar-id').val();
			
			var currentLangSelection = $(this).val();
			$('#grammar-id').val(currentLangSelection);
			
			theJSONGrammarURL = semanticInterpreter.get_json_grammar_url(currentLangSelection);
			
			var callback = function (isSuccess){
				if(isSuccess){
					
					//if previous selection was loaded-from-file -> remove file entry
					//	 (a new one will be created, next time a grammar is loaded from file)
					if( !isLang(prevLang) ){
						$('#lang-selector option[value="'+optionGrammarFromFile+'"]').remove();
					}
					
					clearInput();
					clearOut();
					clearInterpret();
					clearStopword();
					
					initPageWithJsonGrammar();
				}
				else {
					// loading failed -> "revert" selection
					$('#lang-selector option[value="'+currentLangSelection+'"]').prop('selected', null);
					if( isLang(prevLang) ){
						$('#lang-selector option[value="'+prevLang+'"]').prop('selected', 'selected');
					}
					else {
						$('#lang-selector option[value="'+optionGrammarFromFile+'"]').prop('selected', 'selected');
					}
					
					$('#lang-selector').selectmenu('refresh', true);
					currentLangSelection = prevLang;
					
					$('#grammar-id').val(prevLang);
					
				}
			};
			loadJsonGrammar(callback);
			
		});//END: $("#lang-selector").on( "change"...
		
		//set current language in drop-down-box:
		if(false || defLang){
			var selectedLangOption = $('#lang-selector option[value="'+defLang+'"]');
			if( ! selectedLangOption.is('selected')){
				$('#lang-selector option:selected').prop('selected', null);
				selectedLangOption.prop('selected', 'selected');
			}
			
			$('#lang-selector').selectmenu('refresh', true);
		}
		
		
		//overwrite default-impl. for getLanguage (-> use grammar-ID-field value instead of input-field's)
		getLanguage = function(){
			return $('#grammar-id').val();
		}
		
		initFileApi();
		
		if(!inputElement) 
			inputElement = document.getElementById("inputBox");
			
		if(!interpretElement) 
			interpretElement = document.getElementById("interpretationInputBox");
			
		if(!stopwordElement) 
			stopwordElement = document.getElementById("stopwordInputBox");
			

		var callback = function(isSuccess){
			if(isSuccess){
				initPageWithJsonGrammar();
			} 
			else {
				$('#file-selector').trigger('click');
			}
		}
		
		loadJsonGrammar(callback);
	};

	jQuery(document).ready(function(){
		mobileDS.CommonUtils.getInstance().initialize(initPage);
	});
	
	function getLanguage(){
		var id = $('#lang-selector-field').val();
		$('#grammar-id').val(id);
		return id;
	}
	
	function initPageWithJsonGrammar(){
		semanticInterpreter = mobileDS.SemanticInterpreter.getInstance();
		semanticInterpreter.createGrammar(theJSONgrammar, getLanguage());
		
		printGrammarDefinition();
		printInput(JSON.stringify(theJSONgrammar, null, 2));
		printCompiledParserDefinition();
		
		var examplePhrase;
		if(typeof theJSONgrammar.example_phrase !== 'undefined'){
			examplePhrase = theJSONgrammar.example_phrase;
		}
		else {
			examplePhrase = DEFAULT_EXAMPLE_PHRASE;
		}
		
		interpretElement.value = examplePhrase;
		processInterpretation();
	}
	
	function loadJsonGrammar(cb){
		if(!semanticInterpreter){
			semanticInterpreter = mobileDS.SemanticInterpreter.getInstance();
		}
		
		var successFunc = function(gcInstance){
			if(gcInstance.json_grammar_definition){
				
				theJSONgrammar = gcInstance.json_grammar_definition;
				if(theJSONgrammar['comment_license']){
					delete theJSONgrammar['comment_license'];
				}
				cb(true)
			}
			else{
				cb(false);
			}
		};
		var errorFunc =  function(gcInstance){
			alert("Initialize:\n failed to load JSON grammar file from\n '"+theJSONGrammarURL+"'!");
			cb(false);
		};
		
		var gc = new GrammarConverter();
		
		var doLoadGrammar = function(){
			
			gc.loadGrammar(successFunc, errorFunc, theJSONGrammarURL, false);
			
			if($.mobile){
				$.mobile.loading( 'hide' );
			}
		};
		
		setTimeout(function(){
			if($.mobile){
				$.mobile.loading( 'show', {
					text: 'Loading JSON Grammar...',
					textVisible: true
				});
				setTimeout(function(){ doLoadGrammar(); }, 50);
			}
			else {
				doLoadGrammar();
			}
		},50);
		
	}

	function initFileApi() {
		if (window.File && window.FileReader && window.FileList && window.Blob) {
			IS_FILE_READING_API = true;
			$('#file-selector').on('change', loadJsonGrammarFromFile);
		} 
		else {
			$('#file-selector').hide();
		}
	}

	function loadJsonGrammarFromFile(evt) {
		
		if($.mobile){
			$.mobile.loading( 'show', {
				text: 'Loading JSON Grammar from file...',
				textVisible: true
			});
		}
		
	    var files = evt.target.files; // FileList object
	    
	    // Loop through the FileList (should be only one, since "multiple" is not set)
	    for (var i = 0, f; f = files[i]; i++) {

	      var reader = new FileReader();
	      var theFileName = f.name;
	      
	      // Closure to capture the file information.
	      reader.onload = function(theFileEvent) {
				

				var theGrammarId = prompt('Please enter an ID for the grammar:', theFileName);
				if(theGrammarId === null){
					//cancel selected -> do nothing
					return;///////////////////////////// EARLY EXIT ////////////////////////
				}
				
				var prevSel = $('#grammar-id').val();
				$('#grammar-id').val(theGrammarId);
				
				//update selection menu:
				//	* (if previous selection was a file too: remove the previous entry)
				//	* create an entry for the file selection
				//	* de-select previous entry
				//	* select the new file-entry (and update selection menu)
				$('#lang-selector  option[value="'+optionGrammarFromFile+'"]').remove();
				var fileOptionEntry = createLanguageMenuEntry(theGrammarId, null, null, optionGrammarFromFile);//lang, menuElem, defaultSelection, value);
				$('#lang-selector').append( $.parseHTML(fileOptionEntry.join('')) );
				
				if(prevSel !== optionGrammarFromFile){
					$('#lang-selector option[value="'+prevSel+'"]').prop('selected',null);
				}
				$('#lang-selector option[value="'+optionGrammarFromFile+'"]').prop('selected', 'selected');
				$('#lang-selector').selectmenu('refresh', true);
				
		        clearInput();
		        clearOut();
		        clearInterpret();
		        clearStopword();
		        
				theJSONgrammar = $.parseJSON( theFileEvent.target.result );
				
				if(theJSONgrammar['comment_license']){
					delete theJSONgrammar['comment_license'];
				}
				
				$('#inputBox').val(JSON.stringify(theJSONgrammar, null, 2));
				
				initPageWithJsonGrammar();
				$('#file-selector').val(null);
				
				if($.mobile){
					$.mobile.loading( 'hide' );
				}
	      };

	      reader.onerror = function(theFileEvent) {
	    	  var msg = '';
	    	  var e = theFileEvent.target.error;

	    	  switch (e.code) {
	    	    case FileError.QUOTA_EXCEEDED_ERR:
	    	      msg = 'QUOTA_EXCEEDED_ERR';
	    	      break;
	    	    case FileError.NOT_FOUND_ERR:
	    	      msg = 'NOT_FOUND_ERR';
	    	      break;
	    	    case FileError.SECURITY_ERR:
	    	      msg = 'SECURITY_ERR';
	    	      break;
	    	    case FileError.INVALID_MODIFICATION_ERR:
	    	      msg = 'INVALID_MODIFICATION_ERR';
	    	      break;
	    	    case FileError.INVALID_STATE_ERR:
	    	      msg = 'INVALID_STATE_ERR';
	    	      break;
	    	    default:
	    	      msg = 'Unknown Error';
	    	      break;
	    	  };

	    	  alert('Error: ' + msg);
	      };
	      
	      // Read in the file as text (UTF-8)
	      reader.readAsText(f);
	    }
	}
	
	function parseInput(){
		
		if( ! inputTextToJSON() ){
			return
		}
		
		clearOut();
		
		semanticInterpreter = mobileDS.SemanticInterpreter.getInstance();
		
		var langCode = getLanguage();
		if( semanticInterpreter.hasGrammar(langCode) ){
			langCode = prompt('About to replace grammar for:\n'
					+langCode
					+'\n\n\nIf you do not want to replace the grammar\n'
					+      'please enter a different ID:'
				, langCode);
			
			if(langCode === null){
				//-> cancel selected
				return;///////////////////////////// EARLY EXIT ////////////////////////
			}
		}

		var doParseAndCompile = function(){
			semanticInterpreter.createGrammar(theJSONgrammar, langCode);//'theGeneratedTestParser' + (++compileCount));
			printGrammarDefinition();
			printCompiledParserDefinition();
			
			if(typeof theJSONgrammar.example_phrase !== 'undefined'){
				var examplePhrase = theJSONgrammar.example_phrase;
				interpretElement.value = examplePhrase;
				processInterpretation();
			}
			
			if($.mobile){
				$.mobile.loading( 'hide' );
			}
		};
		
		setTimeout(function(){
			if($.mobile){
				$.mobile.loading( 'show', {
					text: 'Parsing and Compiling JSON Grammar...',
					textVisible: true
				});
				setTimeout(function(){ doParseAndCompile(); }, 50);
			}
			else {
				doParseAndCompile();
			}
		},50);

	}
	
	function processInterpretation(){
		
		var asr_result = interpretElement.value;
		var res  = semanticInterpreter.getASRSemantic(    asr_result.toLowerCase(), getLanguage());
		var res2 = semanticInterpreter.getASRSemantic_alt(asr_result.toLowerCase(), getLanguage());
		clearInterpret();
		
		$('#time').text('');
		$('#time-mod').text('');
		
		printInterpretation(res);
		printInterpretationAlt(res2);
		stopword(asr_result);
	}
	
	function benchmarkInterpretation(){
		
		var asr_result = interpretElement.value;
		var res  = semanticInterpreter.getASRSemantic(    asr_result.toLowerCase(), getLanguage());
		var res2 = semanticInterpreter.getASRSemantic_alt(asr_result.toLowerCase(), getLanguage());
		clearInterpret();
		
		var DEFAULT_ITERATIONS = 10000;
		var iterations = DEFAULT_ITERATIONS;
		
		iterations = prompt('Starting Benchmark for evaluting Stopword-Processing implementations.'
				+'\n\nWARNING: This may take several minutes.'
				+'\n\nSpecifiy loops for repeat:'
			,iterations
		);
		
		//was cancel selected?
		if(iterations === null){
			return;///////////////////////////// EARLY EXIT ////////////////////////
		}
		
		iterations = parseInt(iterations);
		
		if(isNaN(iterations)){
			iterations = DEFAULT_ITERATIONS;
		}
		
		
		var doStartBenchmark = function(){

			var startTime = new Date();
			for(var i=0; i < iterations; ++i){
				semanticInterpreter.getASRSemantic(    asr_result.toLowerCase(), getLanguage());
			}
			var diffTime = new Date() - startTime;
			
			var startTimeAlt = new Date();
			for(var i=0; i < iterations; ++i){
				semanticInterpreter.getASRSemantic_alt(asr_result.toLowerCase(), getLanguage());
			}
			var diffTimeAlt = new Date() - startTimeAlt;
			
			$('#time').text(iterations + ' interations in ' + diffTime + ' ms');
			$('#time-mod').text(
					iterations + ' interations in ' + diffTimeAlt
							+ ' ms (alt. method)');
			
			printInterpretation(res);
			printInterpretationAlt(res2);
			stopword(asr_result);
			
			if($.mobile){
				$.mobile.loading( 'hide' );
			}
		};
		
		setTimeout(function(){
				if($.mobile){
					$.mobile.loading( 'show', {
						text: 'Benchmarking ('+iterations+' loops)...',
						textVisible: true
					});
					setTimeout(function(){ doStartBenchmark(); }, 500);
				}
				else {
					doStartBenchmark();
				}
			}, 50
		);
		
	}
	
	function stopword(text){
		var sw_result;
		if(typeof text ==='undefined' || text == null){
			sw_result = stopwordElement.value;
		} else {
			sw_result = text;
			stopwordElement.value = sw_result;
		}
		var res  = semanticInterpreter.removeStopwords(   sw_result.toLowerCase(), getLanguage());
		var res2 = semanticInterpreter.removeStopwords_alt(sw_result.toLowerCase(), getLanguage());
		clearStopword();
		printStopword(res, res2);
	}
	
	function printGrammarDefinition(){
		printCompile(semanticInterpreter.getGrammarDefinitionText( getLanguage() ));
	}
	
	function printCompiledParserDefinition(){
		printCompiledParser(semanticInterpreter.getGrammarParserText( getLanguage() ));
	}
	
	function clearInput() {
		$('#inputBox').val('');
	}
	
	function clearOut() {
		var outputBox = document.getElementById("outputBox");
		outputBox.textContent="";
		outputBox = document.getElementById("compileOutBox");
		outputBox.textContent="";
		outputJSBox = document.getElementById("compiledParserOutBox");
		outputJSBox.textContent="";
		clearInterpret();
		clearStopword();
	}
	
	function clearInterpret() {
		var outputBox = document.getElementById("interpretationBox");
		outputBox.textContent="";
		outputBox = document.getElementById("interpretationBoxAlt");
		outputBox.textContent="";
	}
	
	function clearStopword() {
		var outputBox = document.getElementById("stopwordBox");
		outputBox.textContent="";
		outputBox = document.getElementById("stopwordBox2");
		outputBox.textContent="";
	}
	
	function _error(msg) {
		print("ERROR: " + msg);
	}

	function _warning(msg) {
		print("WARNING: " + msg);
	}

	function _print(msg) {
		print("INFO: " + msg);
	}
	
	var print = (function () {
		var outputBox;
		return function(text) {
			text = text.replace(/[^\r]\n/g, "\r\n");
			if (!outputBox)
				outputBox = document.getElementById("outputBox");
			if(typeof text == "string") {
				outputBox.appendChild(document.createTextNode(text + "\r\n"));
			} else {
				for(var i=0;i<text.length;i++) {
					outputBox.appendChild(document.createTextNode(text[i]
							+ "\r\n"));
				}
			}
		};
	})();
	
	var printCompile = (function () {
		var outputBoxC;
		return function(text) {
			//text = text.replace(/[^\r]\n/g, "\r\n");
			if (!outputBoxC)
				outputBoxC = document.getElementById("compileOutBox");

			outputBoxC.textContent = text + "\r\n";
		};
	})();
	
	var printCompiledParser = (function () {
		var outputBox;
		return function(text) {
			//text = text.replace(/[^\r]\n/g, "\r\n");
			if (!outputBox)
				outputBox = document.getElementById("compiledParserOutBox");
			if(typeof text == "string") {
				outputBox.textContent = text + "\r\n";
			} else {
				for(var i=0;i<text.length;i++) {
					outputBox.appendChild(document.createTextNode(text[i]
							+ "\r\n"));
				}
			}
		};
	})();
	
	var printInterpretation = function(text) {
		doPrintInterpretation(text, true);
	};
	
	var printInterpretationAlt = function(text) {
		doPrintInterpretation(text, false);
	};
	
	var doPrintInterpretation = (function () {
		var outputBox1;
		var outputBox2;
		return function(text, inNormalNotAlt) {
			if(typeof text == "object") {
				if(typeof text.semantic === 'string'){
					text.semantic = JSON.parse(text.semantic);
				}
				text = JSON.stringify(text, null, 2);
			} else 
				text = text.replace(/[^\r]\n/g, "\r\n");

			if (!outputBox1)
				outputBox1 = document.getElementById("interpretationBox");
			if (!outputBox2)
				outputBox2 = document.getElementById("interpretationBoxAlt");
			
			var outputBox = inNormalNotAlt? outputBox1 : outputBox2;
			
			if(typeof text == "string") {
				outputBox.appendChild(document.createTextNode(text + "\r\n"));
			} else {
				for(var i=0;i<text.length;i++) {
					outputBox.appendChild(document.createTextNode(text[i]
							+ "\r\n"));
				}
			}
		};
	})();
	
	var printStopword = (function () {
		var outputBox;
		var outputBox2;
		return function(text, text2) {
			text = text.replace(/[^\r]\n/g, "\r\n");
			if (!outputBox)
				outputBox = document.getElementById("stopwordBox");
			if(typeof text == "string") {
				outputBox.appendChild(document.createTextNode(text + "\r\n"));
			} else {
				for(var i=0;i<text.length;i++) {
					outputBox.appendChild(document.createTextNode(text[i]
							+ "\r\n"));
				}
			}
			
			text2 = text2.replace(/[^\r]\n/g, "\r\n");
			if (!outputBox2)
				outputBox2 = document.getElementById("stopwordBox2");
			if(typeof text2 == "string") {
				outputBox2.appendChild(document.createTextNode(text2 + "\r\n"));
			} else {
				for(var i=0;i<text2.length;i++) {
					outputBox2.appendChild(document.createTextNode(text2[i]
							+ "\r\n"));
				}
			}
		};
	})();
	
	var printInput = (function () {
		var outputBox;
		return function(text) {
			//text = text.replace(/[^\r]\n/g, "\r\n");
			if (!outputBox)
				outputBox = document.getElementById("inputBox");
			
			if(typeof text !== "string") {
				text = text.join('\r\n');				
			}
			
			$(outputBox).val(text+'\r\n');
			return;
			
			/*
			if(typeof text == "string") {
				outputBox.appendChild(document.createTextNode(text + "\r\n"));
			} else {
				for(var i=0;i<text.length;i++) {
					outputBox.appendChild(document.createTextNode(text[i]
							+ "\r\n"));
				}
			}
			*/
		};
	})();
	
	var selectJsonGrammar = (function () {
		var outputBox;
		return function() {
			if (!outputBox)
				outputBox = document.getElementById('inputBox');
			
			outputBox.select();
		};
	})();
	
	var selectJsjcGrammar = (function () {
		var outputBox;
		return function(text) {
			if (!outputBox)
				outputBox = document.getElementById('compileOutBox');
			
			outputBox.select();
		};
	})();
	
	var selectCompiledCode = (function () {
		var outputBox;
		return function(text) {
			if (!outputBox)
				outputBox = document.getElementById('compiledParserOutBox');
			
			outputBox.select();
		};
	})();
	
	function maskJsonValues(){
		
		if( ! inputTextToJSON() ){
			return
		}
		
		var converter = new GrammarConverter();
		theJSONgrammar = converter.maskJSON(theJSONgrammar);
		

		clearInput();
		printInput(JSON.stringify(theJSONgrammar, null, 2));
	}
		
	function unmaskJsonValues(){
		if( ! inputTextToJSON() ){
			return
		}
		
		var converter = new GrammarConverter();
		theJSONgrammar = converter.unmaskJSON(theJSONgrammar);
		

		clearInput();
		printInput(JSON.stringify(theJSONgrammar, null, 2));
	}
	
	function inputTextToJSON(){
		var text = inputElement.value;
		//console.info('gammar-text: \n'+text);
		try{
			theJSONgrammar = JSON.parse(text);
		} catch(error){
			
			console.error('error: '+error.stack);
			
			var msg = error.toString();
			
			//try to get more details for the error using the json-lint parser:
			try {
				
				var result = jsl.parser.parse(text);

				if (result) {
					msg += '\n\nsuccess:\n'+ JSON.stringify(result,null,2);
				}

			} catch (err) {
				msg = err.toString();
			}
			showError(
				'Error',
				'Error on parsing grammar text into a JSON object.',
				'<pre>'+msg+'</pre>'
			);
			return false;
		}
		
		return true;
	}
	
	function createLanguageMenu (arrayLang, defaultSelection){
		
		var menuElem = ['<label for="lang-selector" data-inline="true">Lanuage: </label>',
							'<select name="lang-selector" id="lang-selector">'
						];
		
		if(!defaultSelection){
			menuElem.push('<option>Lanuage</option>');
		}
		
		for(var i=0,size = arrayLang.length; i < size; ++i){
			var lang = arrayLang[i];
			
			createLanguageMenuEntry(lang, menuElem, defaultSelection);
		}
		
		menuElem.push('</select>');
		
		return menuElem.join('');
	}
	
	function createLanguageMenuEntry (lang, menuElem, defaultSelection, value){
		if(!menuElem){
			menuElem = [];
		}
		
		menuElem.push('<option value="');
		if(value){
			menuElem.push(value);
		}
		else {
			menuElem.push(lang);
		}
		
		menuElem.push('"');
		//if(defaultSelection === lang){//for defaultSelection -> initial selection
			//menuElem.push(' data-placeholder="true"');
		//}
		menuElem.push('>');
		menuElem.push(lang);
		menuElem.push('</option>');
		
		return menuElem;
	}
	
	function showError(title, caption, text){
		
		var dlg = $( "#parseErrorPopup" );
		
		if(!title){
			title = '';
		}
		if(!caption){
			caption = '';
		}
		if(!text){
			text = '';
		}
		
		$('#parseErrorPopupTitle', dlg).html(title);
		$('#parseErrorPopupCaption', dlg).html(caption);
		$('#parseErrorPopupText', dlg).html(text);
		
		dlg.popup( "open" )
	}
	</script>
	
	<script type="text/javascript">
	
	//manually implement bookmark-navigation
	// (by default jQuery Mobile interprest bookmarks as dialogs etc. ...)
	$(function(){
		var links = $('a[href^="#"]');

		$('a[href^="#"]').on('click', function(evt){
			var tis = $(this);
			
			//do not 
			if(tis.data('rel'))
				return true;

			var targetLink = tis.attr('href');
			var target = $(targetLink);
			if(target.length === 0){
				var targetName = targetLink.substring(1);
				target = $('[name="'+targetName+'"]');
			}
			var pos = target.offset();
			
			window.scrollTo(pos.left, pos.top);
			
			return false;
		});

	});
		
	</script>
	
</head>

<body>


<!-- ################### Popup dialog: ################################# -->				
	<div data-role="popup" id="parseErrorPopup" data-overlay-theme="a" data-theme="c" data-dismissible="false" class="ui-corner-all">
	    <div data-role="header" data-theme="a" class="ui-corner-top">
	        <h1 id="parseErrorPopupTitle">a short title</h1>
	    </div>
	    <div data-role="content" data-theme="d" class="ui-corner-bottom ui-content">
	        <h3 class="ui-title" id="parseErrorPopupCaption">short description or question.</h3>
	        <p id="parseErrorPopupText">detailed description.</p>
	        <a href="#" data-role="button" data-inline="true" data-rel="back" data-theme="c">OK</a>
	    </div>
	</div>

<!-- ##################################### SECTION: Introduction / heading  ######################################## -->
    
    <a name="top"></a>
    <h1>Semantic Parser Test: Grammar Compiler</h1>
    
    <div style="font-size: 0.9em;width: 100%; white-space: normal !important;">
    <strong>NOTE:</strong>
		On initial load of the page, the <tt>Language</tt> list 
    	is loaded from the file <code>config/directories.json</code>: for each found language
    	directory (<code>config/languages/</code>),	an entry is generated -- on selection, the
    	corresponing JSON file is attempted to be read and compiled.<br/>
    	<i>Note, that there may not be a JSON file for the lanuage available -- in this case an
    	 error message will be shown on selection.</i><br/>
    	
    	<p>You can use the file selector, for loading a JSON grammar from  the local file system</p>
    	
    	<p>Alternatively, you can enter (e.g. copy&paste) a JSON-formatted grammar into the 
    	<i>JSON Grammar Definition</i> field and then press the <i>parse</i> button.</p>
    	<br/>
    </div>
    
    <hr/>
		    		
    <div>
	    <h5  style="display:inline"> TOC: </h5>
	    <fieldset data-role="controlgroup" data-mini="true" data-type="horizontal" style="display:inline;padding-left:2em;">	
	    			<a data-role="button" data-theme="b" data-icon="arrow-d" href="#json-grammer">JSON Grammar</a>
	    			<a data-role="button" data-theme="b" data-icon="arrow-d" href="#interpreter-tester">TEST interpretation</a> 
	    			<a data-role="button" data-theme="b" data-icon="arrow-d" href="#stopword-tester">TEST stopword processing</a>
	    			<a data-role="button" data-theme="b" data-icon="arrow-d" href="#jsjc-grammar">JS/JC Grammar</a>
	    			<a data-role="button" data-theme="b" data-icon="arrow-d" href="#compiled-parser">Compiled parser code</a>
	    </fieldset>  
    </div>
    <hr/>
    
<!-- ##################################### SECTION: JSON Grammar Definition  ######################################## -->
    
	<div class="ui-body-d" style="float:right;padding:1em;margin:0.5em;">
		<h4>Load Grammar Options: </h4>
		<div id="language-selection-area" class="grid-cell">
			<div id="lang-selector-manual-input">
				<label for="lang-selector-field">Language:</label> 
				<input type="text" id="lang-selector-field" />
			</div>
			<div id="lang-selector" style="display:none;"></div>
		</div>
		<div class="grid-cell">
			<input type="file" id="file-selector" accept="text" name="files[]" />
		</div>
	</div>
	
    
	<a name="json-grammar"></a>
	<div style="float:left;" class="grid">
    	<div class="grid-cell" style="vertical-align: middle;padding-right:3em;">
    		<a href="#top" data-theme="b" data-role="button" data-mini="true" data-icon="arrow-u">top</a>
    	</div>
		<div class="grid-cell">
    		<h2>JSON Grammar Definition:</h2> 
    	</div>
	</div>
	
	<div style="clear:both;"></div>
		
    <div style="float:left; width: 70%;">
	    <h5>JSON grammar definition:</h5>
		<textarea id="inputBox" rows="20" style="width: 100%;height:300px;" data-role="none" data-enhance="false"></textarea><br/>
		
		<div style="float:left;">
			<input type="button" onclick="selectJsonGrammar();" value="Select All" style="right:0;"/>
		</div><div style="float:right;"  class="grid">
			
			<div class="grid-cell">
				<input type="button" onclick="parseInput();" value="Parse"/>
			</div>
			
			<fieldset class="grid-cell" style="padding-left:0.2em;">
				<label for="grammar-id">Grammar ID:</label>
				<input id="grammar-id" type="text" data-inline="true"/>
			</fieldset>
			
			<div class="grid-cell" style="vertical-align:middle">
				<a href="#popupGrammarIdInfo" 
					class="ui-icon-alt" 
					data-rel="popup" 
					data-role="button" 
					data-inline="true" 
					data-transition="pop" 
					data-icon="info" 
					data-theme="e" 
					data-iconpos="notext">
					 
					Grammar ID information
				</a>
				<div data-role="popup" id="popupGrammarIdInfo" class="ui-content" data-theme="e" style="max-width:350px;">
				  <p>The <strong>Grammar ID</strong> 
				  	identifies the grammar.<br/>
				  	If a grammar with the same ID already exists, it will replaced.<br/>
				  </p>
				</div>
			</div>
			
			<div class="grid-cell" style="padding-left:2em;">
				<fieldset data-role="controlgroup" data-type="horizontal">
					<input type="button" onclick="maskJsonValues()" value="mask"/>
					<input type="button" onclick="unmaskJsonValues()" value="unmask"/>
				</fieldset>
			</div>
			<div class="grid-cell" style="vertical-align:middle">
				<a href="#popupMaskingInfo" 
					class="ui-icon-alt" 
					data-rel="popup" 
					data-role="button" 
					data-inline="true" 
					data-transition="pop" 
					data-icon="info" 
					data-theme="e" 
					data-iconpos="notext">
					 
					Masking information
				</a>
				<div data-role="popup" id="popupMaskingInfo" class="ui-content" data-theme="e" style="max-width:350px;">
				  <p>If the JSON values contain <strong>unicode</strong>
				  	characters (i.e. non-ASCII chars), they will get <em>masked</em> before creating
				  	the JS/CC definition, and compiling the executable JavaScript grammar.
				  	<br/><br/>
				  	You can preview the effets of <em>masking</em> by using
				  	<strong>mask</strong> and <strong>unmask</strong>.
				  	<br/><br/>
				  	
				  	<strong>NOTE</strong> that the grammar will not be able
				  	to detect tokens that correspond to the masking pattern itself,
				  	e.g. the token <code>~~751F~~</code> will not be detected, but
				  	instead its <em>unmasked</em> representation <code>&#x751F;</code>.
				  	<br/><br/>
				  </p>
				</div>
			</div>
			
		</div>
		<div style="clear:both;"></div>
		
		<!-- input type="button" onclick="clearOut();" value="Clear"/-->
		
		<br/>
    </div>
    <div style="float:right; width: 27%;">
	    <h5>Output/Error:</h5>
	    <div id="outputBox"></div>
    </div>
	
	<div style="clear: both;"></div>
    
<!-- ##################################### SECTION: Semantic Parser Test: Interpertation  ######################################## -->
    
    <div style="float:left; clear: left; width: 100%;"><div style="clear: right; width: 100%;">
	
		<table width="100%" border="0">
			<tr>
				<td colspan="3">
					<hr/>
					<a name="interpreter-tester"></a><br/>
					<div style="float:left;" class="grid">
				    	<div class="grid-cell" style="vertical-align: middle;padding-right:3em;">
				    		<a href="#top" data-theme="b" data-role="button" data-mini="true" data-icon="arrow-u">top</a>
				    	</div>
						<div class="grid-cell">
							<h2>Semantic Parser Test: Interpertation</h2>
				    	</div>
					</div>
				</td>
			</tr>
			<tr>
				<td valign="top">
					<h5>TEST Interpret Sentence:</h5>
					<textarea id="interpretationInputBox" rows="1" cols="30"></textarea>
					<br/>
					<input type="button" onclick="processInterpretation();" value="Interpret"/>
					<br/>
					<input type="button" onclick="benchmarkInterpretation();" value="Benchmark"/>
					<br/>
					<span id="time"></span>
					<br/>
					<span id="time-mod"></span>
				</td>
				<td valign="top">
					<h5>Interpreter Result:</h5>
					<div id="interpretationBox"></div>
				</td>
				<td valign="top">
					<h5>Alternate Interpreter Result:
						<span style="font-size:x-small;font-weight: lighter;">
							(using alternate method for stopword removal)
						</span>
					</h5>
					<div id="interpretationBoxAlt"></div>
				</td>
			</tr>
			<tr>
				<td colspan="3">
					<hr/>
					<a name="stopword-tester"></a><br/>
					
					<div style="float:left;" class="grid">
				    	<div class="grid-cell" style="vertical-align: middle;padding-right:3em;">
				    		<a href="#top" data-theme="b" data-role="button" data-mini="true" data-icon="arrow-u">top</a>
				    	</div>
						<div class="grid-cell">
							<h2>Semantic Parser Test: Stopword</h2>
				    	</div>
					</div>
				</td>
				
			</tr>
			<tr>
				<td valign="top">
					<h5>TEST Process Stopwords:</h5>
					<textarea id="stopwordInputBox" rows="1" cols="30"></textarea>
					<br/>
					<input type="button" onclick="stopword();" value="Apply Stopwords"/>
				</td>
				<td valign="top">
					<h5>Stopword Result (Method 1):</h5>
					<div id="stopwordBox"></div>
				</td>
				<td valign="top">					
					<h5>Stopword Result (Method 2):</h5>
					<div id="stopwordBox2"></div>
				</td>
			</tr>
		</table>
		
		<hr/>


<!-- ##################################### SECTION: JS/JC Grammar Definition ######################################## -->
    
		
		<div>
			<a name="jsjc-grammar"></a>
		    <div style="float:left;" class="grid">
		    	<div class="grid-cell" style="vertical-align: middle;padding-right:3em;">
		    		<a href="#top" data-theme="b" data-role="button" data-mini="true" data-icon="arrow-u">top</a>
		    	</div>
		    	<div class="grid-cell">
		    		<h2>JS/JC Grammar Definition (generated from JSON grammar):</h2>
		    	</div>
		    </div>
			<div style="clear:both;"></div>
		    	
		    <p>This is the specification of grammar in <a target="jscc" href="http://jscc.phorward-software.com/">JS/CC</a> syntax</p>
			<textarea  id="compileOutBox" readonly="readonly"></textarea>
			
			<div style="float:left;">
				<input type="button" onclick="selectJsjcGrammar();" value="Select All"/>
			</div>
			<div style="clear:both;"></div>
		</div>
		
		<hr/>

<!-- ##################################### SECTION: Compiled Parser Code (JavaScript) ######################################## -->
    
		<div style="width: 100%;">
		
			<a name="compiled-parser"></a>
		
		    <div style="float:left;" class="grid">
		    	<div class="grid-cell" style="vertical-align: middle;padding-right:3em;">
		    		<a href="#top" data-theme="b" data-role="button" data-mini="true" data-icon="arrow-u">top</a>
		    	</div>
		    	<div class="grid-cell">
					<h2>Compiled Parser Code:</h2>
		    	</div>
		    </div>
			<div style="clear:both;"></div>
			
			<p>	
				This is the compiled JavaScript code for the grammar.
			</p>
			<p>
				This code can be copied into a file: on loading (i.e. interpreting)
				the JavaScript file, the grammar will be registered with the
				<tt>SemanticInterpreter</tt> for the <em>Grammar ID</em> that is specified above
				in the <a href="#json-grammar">Grammar Definition</a> section.
			</p>
			<div>
				The default location for the compiled JavaScript grammar files is
				<pre style="display:inline;">assets/www/gen/grammar/[Grammar ID]_grammar.json</pre>
			</div>
			<br/>
			
			<div style="float:left;">
				<input type="button" onclick="selectCompiledCode();" value="Select All"/>
			</div>
			<div style="clear:both;"></div>
			
			<textarea id="compiledParserOutBox" readonly="readonly"></textarea>
		</div>
    </div></div>
	
</body>
</html>                                                                                                                                                                            